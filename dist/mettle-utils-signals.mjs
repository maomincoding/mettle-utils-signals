const t=Symbol.for("mettle-signals");function e(){if(n>1)return void n--;let t,e=!1;for(;void 0!==s;){let o=s;for(s=void 0,_++;void 0!==o;){const i=o._nextBatchedEffect;if(o._nextBatchedEffect=void 0,o._flags&=-3,!(8&o._flags)&&h(o))try{o._callback()}catch(o){e||(t=o,e=!0)}o=i}}if(_=0,n--,e)throw t}function o(t){if(n>0)return t();/*@__INLINE__**/n++;try{return t()}finally{e()}}let i,s;function r(t){const e=i;i=void 0;try{return t()}finally{i=e}}let n=0,_=0,c=0;function u(t){if(void 0===i)return;let e=t._node;return void 0===e||e._target!==i?(e={_version:0,_source:t,_prevSource:i._sources,_nextSource:void 0,_target:i,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},void 0!==i._sources&&(i._sources._nextSource=e),i._sources=e,t._node=e,32&i._flags&&t._subscribe(e),e):-1===e._version?(e._version=0,void 0!==e._nextSource&&(e._nextSource._prevSource=e._prevSource,void 0!==e._prevSource&&(e._prevSource._nextSource=e._nextSource),e._prevSource=i._sources,e._nextSource=void 0,i._sources._nextSource=e,i._sources=e),e):void 0}function a(t,e){this._value=t,this._version=0,this._node=void 0,this._targets=void 0,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function f(t,e){return new a(t,e)}function h(t){for(let e=t._sources;void 0!==e;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function l(t){for(let e=t._sources;void 0!==e;e=e._nextSource){const o=e._source._node;if(void 0!==o&&(e._rollbackNode=o),e._source._node=e,e._version=-1,void 0===e._nextSource){t._sources=e;break}}}function v(t){let e,o=t._sources;for(;void 0!==o;){const t=o._prevSource;-1===o._version?(o._source._unsubscribe(o),void 0!==t&&(t._nextSource=o._nextSource),void 0!==o._nextSource&&(o._nextSource._prevSource=t)):e=o,o._source._node=o._rollbackNode,void 0!==o._rollbackNode&&(o._rollbackNode=void 0),o=t}t._sources=e}function d(t,e){a.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=c-1,this._flags=4,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function p(t,e){return new d(t,e)}function g(t){const o=t._cleanup;if(t._cleanup=void 0,"function"==typeof o){n++;const s=i;i=void 0;try{o()}catch(e){throw t._flags&=-2,t._flags|=8,y(t),e}finally{i=s,e()}}}function y(t){for(let e=t._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,g(t)}function b(t){if(i!==this)throw new Error("Out-of-order effect");v(this),i=t,this._flags&=-2,8&this._flags&&y(this),e()}function x(t,e){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=32,this.name=null==e?void 0:e.name}function S(t,e){const o=new x(t,e);try{o._callback()}catch(t){throw o._dispose(),t}const i=o._dispose.bind(o);return i[Symbol.dispose]=i,i}a.prototype.brand=t,a.prototype._refresh=function(){return!0},a.prototype._subscribe=function(t){const e=this._targets;e!==t&&void 0===t._prevTarget&&(t._nextTarget=e,this._targets=t,void 0!==e?e._prevTarget=t:r(()=>{var t;null==(t=this._watched)||t.call(this)}))},a.prototype._unsubscribe=function(t){if(void 0!==this._targets){const e=t._prevTarget,o=t._nextTarget;void 0!==e&&(e._nextTarget=o,t._prevTarget=void 0),void 0!==o&&(o._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=o,void 0===o&&r(()=>{var t;null==(t=this._unwatched)||t.call(this)}))}},a.prototype.subscribe=function(t){return S(()=>{const e=this.value,o=i;i=void 0;try{t(e)}finally{i=o}},{name:"sub"})},a.prototype.valueOf=function(){return this.value},a.prototype.toString=function(){return this.value+""},a.prototype.toJSON=function(){return this.value},a.prototype.peek=function(){const t=i;i=void 0;try{return this.value}finally{i=t}},Object.defineProperty(a.prototype,"value",{get(){const t=u(this);return void 0!==t&&(t._version=this._version),this._value},set(t){if(t!==this._value){if(_>100)throw new Error("Cycle detected");this._value=t,this._version++,c++,n++;try{for(let t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}finally{e()}}}}),(d.prototype=new a)._refresh=function(){if(this._flags&=-3,1&this._flags)return!1;if(32==(36&this._flags))return!0;if(this._flags&=-5,this._globalVersion===c)return!0;if(this._globalVersion=c,this._flags|=1,this._version>0&&!h(this))return this._flags&=-2,!0;const t=i;try{l(this),i=this;const t=this._fn();(16&this._flags||this._value!==t||0===this._version)&&(this._value=t,this._flags&=-17,this._version++)}catch(t){this._value=t,this._flags|=16,this._version++}return i=t,v(this),this._flags&=-2,!0},d.prototype._subscribe=function(t){if(void 0===this._targets){this._flags|=36;for(let t=this._sources;void 0!==t;t=t._nextSource)t._source._subscribe(t)}a.prototype._subscribe.call(this,t)},d.prototype._unsubscribe=function(t){if(void 0!==this._targets&&(a.prototype._unsubscribe.call(this,t),void 0===this._targets)){this._flags&=-33;for(let t=this._sources;void 0!==t;t=t._nextSource)t._source._unsubscribe(t)}},d.prototype._notify=function(){if(!(2&this._flags)){this._flags|=6;for(let t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}},Object.defineProperty(d.prototype,"value",{get(){if(1&this._flags)throw new Error("Cycle detected");const t=u(this);if(this._refresh(),void 0!==t&&(t._version=this._version),16&this._flags)throw this._value;return this._value}}),x.prototype._callback=function(){const t=this._start();try{if(8&this._flags)return;if(void 0===this._fn)return;const t=this._fn();"function"==typeof t&&(this._cleanup=t)}finally{t()}},x.prototype._start=function(){if(1&this._flags)throw new Error("Cycle detected");this._flags|=1,this._flags&=-9,g(this),l(this),n++;const t=i;return i=this,b.bind(this,t)},x.prototype._notify=function(){2&this._flags||(this._flags|=2,this._nextBatchedEffect=s,s=this)},x.prototype._dispose=function(){this._flags|=8,1&this._flags||y(this)},x.prototype.dispose=function(){this._dispose()};export{d as Computed,x as Effect,a as Signal,o as batch,p as computed,S as effect,f as signal,r as untracked};
