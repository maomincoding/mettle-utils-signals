!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).mettleUtilsSignals={})}(this,function(t){var e=Symbol.for("mettle-signals");function i(){if(n>1)n--;else{for(var t,e=!1;void 0!==s;){var i=s;for(s=void 0,_++;void 0!==i;){var r=i._nextBatchedEffect;if(i._nextBatchedEffect=void 0,i._flags&=-3,!(8&i._flags)&&f(i))try{i._callback()}catch(i){e||(t=i,e=!0)}i=r}}if(_=0,n--,e)throw t}}var r=void 0;function o(t){var e=r;r=void 0;try{return t()}finally{r=e}}var s=void 0,n=0,_=0,u=0;function a(t){if(void 0!==r){var e=t._node;return void 0===e||e._target!==r?(e={_version:0,_source:t,_prevSource:r._sources,_nextSource:void 0,_target:r,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},void 0!==r._sources&&(r._sources._nextSource=e),r._sources=e,t._node=e,32&r._flags&&t._subscribe(e),e):-1===e._version?(e._version=0,void 0!==e._nextSource&&(e._nextSource._prevSource=e._prevSource,void 0!==e._prevSource&&(e._prevSource._nextSource=e._nextSource),e._prevSource=r._sources,e._nextSource=void 0,r._sources._nextSource=e,r._sources=e),e):void 0}}function c(t,e){this._value=t,this._version=0,this._node=void 0,this._targets=void 0,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function f(t){for(var e=t._sources;void 0!==e;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function v(t){for(var e=t._sources;void 0!==e;e=e._nextSource){var i=e._source._node;if(void 0!==i&&(e._rollbackNode=i),e._source._node=e,e._version=-1,void 0===e._nextSource){t._sources=e;break}}}function h(t){for(var e=t._sources,i=void 0;void 0!==e;){var r=e._prevSource;-1===e._version?(e._source._unsubscribe(e),void 0!==r&&(r._nextSource=e._nextSource),void 0!==e._nextSource&&(e._nextSource._prevSource=r)):i=e,e._source._node=e._rollbackNode,void 0!==e._rollbackNode&&(e._rollbackNode=void 0),e=r}t._sources=i}function l(t,e){c.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=u-1,this._flags=4,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function d(t){var e=t._cleanup;if(t._cleanup=void 0,"function"==typeof e){n++;var o=r;r=void 0;try{e()}catch(e){throw t._flags&=-2,t._flags|=8,p(t),e}finally{r=o,i()}}}function p(t){for(var e=t._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,d(t)}function g(t){if(r!==this)throw new Error("Out-of-order effect");h(this),r=t,this._flags&=-2,8&this._flags&&p(this),i()}function y(t,e){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=32,this.name=null==e?void 0:e.name}function b(t,e){var i=new y(t,e);try{i._callback()}catch(t){throw i._dispose(),t}var r=i._dispose.bind(i);return r[Symbol.dispose]=r,r}c.prototype.brand=e,c.prototype._refresh=function(){return!0},c.prototype._subscribe=function(t){var e=this,i=this._targets;i!==t&&void 0===t._prevTarget&&(t._nextTarget=i,this._targets=t,void 0!==i?i._prevTarget=t:o(function(){var t;null==(t=e._watched)||t.call(e)}))},c.prototype._unsubscribe=function(t){var e=this;if(void 0!==this._targets){var i=t._prevTarget,r=t._nextTarget;void 0!==i&&(i._nextTarget=r,t._prevTarget=void 0),void 0!==r&&(r._prevTarget=i,t._nextTarget=void 0),t===this._targets&&(this._targets=r,void 0===r&&o(function(){var t;null==(t=e._unwatched)||t.call(e)}))}},c.prototype.subscribe=function(t){var e=this;return b(function(){var i=e.value,o=r;r=void 0;try{t(i)}finally{r=o}},{name:"sub"})},c.prototype.valueOf=function(){return this.value},c.prototype.toString=function(){return this.value+""},c.prototype.toJSON=function(){return this.value},c.prototype.peek=function(){var t=r;r=void 0;try{return this.value}finally{r=t}},Object.defineProperty(c.prototype,"value",{get:function(){var t=a(this);return void 0!==t&&(t._version=this._version),this._value},set:function(t){if(t!==this._value){if(_>100)throw new Error("Cycle detected");this._value=t,this._version++,u++,n++;try{for(var e=this._targets;void 0!==e;e=e._nextTarget)e._target._notify()}finally{i()}}}}),(l.prototype=new c)._refresh=function(){if(this._flags&=-3,1&this._flags)return!1;if(32==(36&this._flags))return!0;if(this._flags&=-5,this._globalVersion===u)return!0;if(this._globalVersion=u,this._flags|=1,this._version>0&&!f(this))return this._flags&=-2,!0;var t=r;try{v(this),r=this;var e=this._fn();(16&this._flags||this._value!==e||0===this._version)&&(this._value=e,this._flags&=-17,this._version++)}catch(t){this._value=t,this._flags|=16,this._version++}return r=t,h(this),this._flags&=-2,!0},l.prototype._subscribe=function(t){if(void 0===this._targets){this._flags|=36;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._subscribe(e)}c.prototype._subscribe.call(this,t)},l.prototype._unsubscribe=function(t){if(void 0!==this._targets&&(c.prototype._unsubscribe.call(this,t),void 0===this._targets)){this._flags&=-33;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e)}},l.prototype._notify=function(){if(!(2&this._flags)){this._flags|=6;for(var t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}},Object.defineProperty(l.prototype,"value",{get:function(){if(1&this._flags)throw new Error("Cycle detected");var t=a(this);if(this._refresh(),void 0!==t&&(t._version=this._version),16&this._flags)throw this._value;return this._value}}),y.prototype._callback=function(){var t=this._start();try{if(8&this._flags)return;if(void 0===this._fn)return;var e=this._fn();"function"==typeof e&&(this._cleanup=e)}finally{t()}},y.prototype._start=function(){if(1&this._flags)throw new Error("Cycle detected");this._flags|=1,this._flags&=-9,d(this),v(this),n++;var t=r;return r=this,g.bind(this,t)},y.prototype._notify=function(){2&this._flags||(this._flags|=2,this._nextBatchedEffect=s,s=this)},y.prototype._dispose=function(){this._flags|=8,1&this._flags||p(this)},y.prototype.dispose=function(){this._dispose()},t.Computed=l,t.Effect=y,t.Signal=c,t.batch=function(t){if(n>0)return t();/*@__INLINE__**/n++;try{return t()}finally{i()}},t.computed=function(t,e){return new l(t,e)},t.effect=b,t.signal=function(t,e){return new c(t,e)},t.untracked=o});
