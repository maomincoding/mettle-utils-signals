var t=Symbol.for("mettle-signals");function e(){if(n>1)n--;else{for(var t,e=!1;void 0!==s;){var r=s;for(s=void 0,_++;void 0!==r;){var i=r._nextBatchedEffect;if(r._nextBatchedEffect=void 0,r._flags&=-3,!(8&r._flags)&&f(r))try{r._callback()}catch(r){e||(t=r,e=!0)}r=i}}if(_=0,n--,e)throw t}}function r(t){if(n>0)return t();/*@__INLINE__**/n++;try{return t()}finally{e()}}var i=void 0;function o(t){var e=i;i=void 0;try{return t()}finally{i=e}}var s=void 0,n=0,_=0,u=0;function a(t){if(void 0!==i){var e=t._node;return void 0===e||e._target!==i?(e={_version:0,_source:t,_prevSource:i._sources,_nextSource:void 0,_target:i,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},void 0!==i._sources&&(i._sources._nextSource=e),i._sources=e,t._node=e,32&i._flags&&t._subscribe(e),e):-1===e._version?(e._version=0,void 0!==e._nextSource&&(e._nextSource._prevSource=e._prevSource,void 0!==e._prevSource&&(e._prevSource._nextSource=e._nextSource),e._prevSource=i._sources,e._nextSource=void 0,i._sources._nextSource=e,i._sources=e),e):void 0}}function c(t,e){this._value=t,this._version=0,this._node=void 0,this._targets=void 0,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function v(t,e){return new c(t,e)}function f(t){for(var e=t._sources;void 0!==e;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function h(t){for(var e=t._sources;void 0!==e;e=e._nextSource){var r=e._source._node;if(void 0!==r&&(e._rollbackNode=r),e._source._node=e,e._version=-1,void 0===e._nextSource){t._sources=e;break}}}function l(t){for(var e=t._sources,r=void 0;void 0!==e;){var i=e._prevSource;-1===e._version?(e._source._unsubscribe(e),void 0!==i&&(i._nextSource=e._nextSource),void 0!==e._nextSource&&(e._nextSource._prevSource=i)):r=e,e._source._node=e._rollbackNode,void 0!==e._rollbackNode&&(e._rollbackNode=void 0),e=i}t._sources=r}function d(t,e){c.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=u-1,this._flags=4,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function p(t,e){return new d(t,e)}function g(t){var r=t._cleanup;if(t._cleanup=void 0,"function"==typeof r){n++;var o=i;i=void 0;try{r()}catch(e){throw t._flags&=-2,t._flags|=8,y(t),e}finally{i=o,e()}}}function y(t){for(var e=t._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,g(t)}function b(t){if(i!==this)throw new Error("Out-of-order effect");l(this),i=t,this._flags&=-2,8&this._flags&&y(this),e()}function x(t,e){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=32,this.name=null==e?void 0:e.name}function S(t,e){var r=new x(t,e);try{r._callback()}catch(t){throw r._dispose(),t}var i=r._dispose.bind(r);return i[Symbol.dispose]=i,i}c.prototype.brand=t,c.prototype._refresh=function(){return!0},c.prototype._subscribe=function(t){var e=this,r=this._targets;r!==t&&void 0===t._prevTarget&&(t._nextTarget=r,this._targets=t,void 0!==r?r._prevTarget=t:o(function(){var t;null==(t=e._watched)||t.call(e)}))},c.prototype._unsubscribe=function(t){var e=this;if(void 0!==this._targets){var r=t._prevTarget,i=t._nextTarget;void 0!==r&&(r._nextTarget=i,t._prevTarget=void 0),void 0!==i&&(i._prevTarget=r,t._nextTarget=void 0),t===this._targets&&(this._targets=i,void 0===i&&o(function(){var t;null==(t=e._unwatched)||t.call(e)}))}},c.prototype.subscribe=function(t){var e=this;return S(function(){var r=e.value,o=i;i=void 0;try{t(r)}finally{i=o}},{name:"sub"})},c.prototype.valueOf=function(){return this.value},c.prototype.toString=function(){return this.value+""},c.prototype.toJSON=function(){return this.value},c.prototype.peek=function(){var t=i;i=void 0;try{return this.value}finally{i=t}},Object.defineProperty(c.prototype,"value",{get:function(){var t=a(this);return void 0!==t&&(t._version=this._version),this._value},set:function(t){if(t!==this._value){if(_>100)throw new Error("Cycle detected");this._value=t,this._version++,u++,n++;try{for(var r=this._targets;void 0!==r;r=r._nextTarget)r._target._notify()}finally{e()}}}}),(d.prototype=new c)._refresh=function(){if(this._flags&=-3,1&this._flags)return!1;if(32==(36&this._flags))return!0;if(this._flags&=-5,this._globalVersion===u)return!0;if(this._globalVersion=u,this._flags|=1,this._version>0&&!f(this))return this._flags&=-2,!0;var t=i;try{h(this),i=this;var e=this._fn();(16&this._flags||this._value!==e||0===this._version)&&(this._value=e,this._flags&=-17,this._version++)}catch(t){this._value=t,this._flags|=16,this._version++}return i=t,l(this),this._flags&=-2,!0},d.prototype._subscribe=function(t){if(void 0===this._targets){this._flags|=36;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._subscribe(e)}c.prototype._subscribe.call(this,t)},d.prototype._unsubscribe=function(t){if(void 0!==this._targets&&(c.prototype._unsubscribe.call(this,t),void 0===this._targets)){this._flags&=-33;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e)}},d.prototype._notify=function(){if(!(2&this._flags)){this._flags|=6;for(var t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}},Object.defineProperty(d.prototype,"value",{get:function(){if(1&this._flags)throw new Error("Cycle detected");var t=a(this);if(this._refresh(),void 0!==t&&(t._version=this._version),16&this._flags)throw this._value;return this._value}}),x.prototype._callback=function(){var t=this._start();try{if(8&this._flags)return;if(void 0===this._fn)return;var e=this._fn();"function"==typeof e&&(this._cleanup=e)}finally{t()}},x.prototype._start=function(){if(1&this._flags)throw new Error("Cycle detected");this._flags|=1,this._flags&=-9,g(this),h(this),n++;var t=i;return i=this,b.bind(this,t)},x.prototype._notify=function(){2&this._flags||(this._flags|=2,this._nextBatchedEffect=s,s=this)},x.prototype._dispose=function(){this._flags|=8,1&this._flags||y(this)},x.prototype.dispose=function(){this._dispose()};export{d as Computed,x as Effect,c as Signal,r as batch,p as computed,S as effect,v as signal,o as untracked};
