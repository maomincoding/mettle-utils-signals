var t=Symbol.for("mettle-signals");function e(){if(s>1)s--;else{for(var t,e=!1;void 0!==i;){var r=i;for(i=void 0,n++;void 0!==r;){var o=r._nextBatchedEffect;if(r._nextBatchedEffect=void 0,r._flags&=-3,!(8&r._flags)&&c(r))try{r._callback()}catch(r){e||(t=r,e=!0)}r=o}}if(n=0,s--,e)throw t}}var r=void 0;function o(t){var e=r;r=void 0;try{return t()}finally{r=e}}var i=void 0,s=0,n=0,_=0;function a(t){if(void 0!==r){var e=t._node;return void 0===e||e._target!==r?(e={_version:0,_source:t,_prevSource:r._sources,_nextSource:void 0,_target:r,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},void 0!==r._sources&&(r._sources._nextSource=e),r._sources=e,t._node=e,32&r._flags&&t._subscribe(e),e):-1===e._version?(e._version=0,void 0!==e._nextSource&&(e._nextSource._prevSource=e._prevSource,void 0!==e._prevSource&&(e._prevSource._nextSource=e._nextSource),e._prevSource=r._sources,e._nextSource=void 0,r._sources._nextSource=e,r._sources=e),e):void 0}}function u(t,e){this._value=t,this._version=0,this._node=void 0,this._targets=void 0,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function c(t){for(var e=t._sources;void 0!==e;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function v(t){for(var e=t._sources;void 0!==e;e=e._nextSource){var r=e._source._node;if(void 0!==r&&(e._rollbackNode=r),e._source._node=e,e._version=-1,void 0===e._nextSource){t._sources=e;break}}}function f(t){for(var e=t._sources,r=void 0;void 0!==e;){var o=e._prevSource;-1===e._version?(e._source._unsubscribe(e),void 0!==o&&(o._nextSource=e._nextSource),void 0!==e._nextSource&&(e._nextSource._prevSource=o)):r=e,e._source._node=e._rollbackNode,void 0!==e._rollbackNode&&(e._rollbackNode=void 0),e=o}t._sources=r}function h(t,e){u.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=_-1,this._flags=4,this._watched=null==e?void 0:e.watched,this._unwatched=null==e?void 0:e.unwatched,this.name=null==e?void 0:e.name}function l(t){var o=t._cleanup;if(t._cleanup=void 0,"function"==typeof o){s++;var i=r;r=void 0;try{o()}catch(e){throw t._flags&=-2,t._flags|=8,d(t),e}finally{r=i,e()}}}function d(t){for(var e=t._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,l(t)}function p(t){if(r!==this)throw new Error("Out-of-order effect");f(this),r=t,this._flags&=-2,8&this._flags&&d(this),e()}function g(t,e){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=32,this.name=null==e?void 0:e.name}function y(t,e){var r=new g(t,e);try{r._callback()}catch(t){throw r._dispose(),t}var o=r._dispose.bind(r);return o[Symbol.dispose]=o,o}u.prototype.brand=t,u.prototype._refresh=function(){return!0},u.prototype._subscribe=function(t){var e=this,r=this._targets;r!==t&&void 0===t._prevTarget&&(t._nextTarget=r,this._targets=t,void 0!==r?r._prevTarget=t:o(function(){var t;null==(t=e._watched)||t.call(e)}))},u.prototype._unsubscribe=function(t){var e=this;if(void 0!==this._targets){var r=t._prevTarget,i=t._nextTarget;void 0!==r&&(r._nextTarget=i,t._prevTarget=void 0),void 0!==i&&(i._prevTarget=r,t._nextTarget=void 0),t===this._targets&&(this._targets=i,void 0===i&&o(function(){var t;null==(t=e._unwatched)||t.call(e)}))}},u.prototype.subscribe=function(t){var e=this;return y(function(){var o=e.value,i=r;r=void 0;try{t(o)}finally{r=i}},{name:"sub"})},u.prototype.valueOf=function(){return this.value},u.prototype.toString=function(){return this.value+""},u.prototype.toJSON=function(){return this.value},u.prototype.peek=function(){var t=r;r=void 0;try{return this.value}finally{r=t}},Object.defineProperty(u.prototype,"value",{get:function(){var t=a(this);return void 0!==t&&(t._version=this._version),this._value},set:function(t){if(t!==this._value){if(n>100)throw new Error("Cycle detected");this._value=t,this._version++,_++,s++;try{for(var r=this._targets;void 0!==r;r=r._nextTarget)r._target._notify()}finally{e()}}}}),(h.prototype=new u)._refresh=function(){if(this._flags&=-3,1&this._flags)return!1;if(32==(36&this._flags))return!0;if(this._flags&=-5,this._globalVersion===_)return!0;if(this._globalVersion=_,this._flags|=1,this._version>0&&!c(this))return this._flags&=-2,!0;var t=r;try{v(this),r=this;var e=this._fn();(16&this._flags||this._value!==e||0===this._version)&&(this._value=e,this._flags&=-17,this._version++)}catch(t){this._value=t,this._flags|=16,this._version++}return r=t,f(this),this._flags&=-2,!0},h.prototype._subscribe=function(t){if(void 0===this._targets){this._flags|=36;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._subscribe(e)}u.prototype._subscribe.call(this,t)},h.prototype._unsubscribe=function(t){if(void 0!==this._targets&&(u.prototype._unsubscribe.call(this,t),void 0===this._targets)){this._flags&=-33;for(var e=this._sources;void 0!==e;e=e._nextSource)e._source._unsubscribe(e)}},h.prototype._notify=function(){if(!(2&this._flags)){this._flags|=6;for(var t=this._targets;void 0!==t;t=t._nextTarget)t._target._notify()}},Object.defineProperty(h.prototype,"value",{get:function(){if(1&this._flags)throw new Error("Cycle detected");var t=a(this);if(this._refresh(),void 0!==t&&(t._version=this._version),16&this._flags)throw this._value;return this._value}}),g.prototype._callback=function(){var t=this._start();try{if(8&this._flags)return;if(void 0===this._fn)return;var e=this._fn();"function"==typeof e&&(this._cleanup=e)}finally{t()}},g.prototype._start=function(){if(1&this._flags)throw new Error("Cycle detected");this._flags|=1,this._flags&=-9,l(this),v(this),s++;var t=r;return r=this,p.bind(this,t)},g.prototype._notify=function(){2&this._flags||(this._flags|=2,this._nextBatchedEffect=i,i=this)},g.prototype._dispose=function(){this._flags|=8,1&this._flags||d(this)},g.prototype.dispose=function(){this._dispose()},exports.Computed=h,exports.Effect=g,exports.Signal=u,exports.batch=function(t){if(s>0)return t();/*@__INLINE__**/s++;try{return t()}finally{e()}},exports.computed=function(t,e){return new h(t,e)},exports.effect=y,exports.signal=function(t,e){return new u(t,e)},exports.untracked=o;
